<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Converter | Cadastro de Fornecedores/Clientes</title>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Ubuntu', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.5s ease;
        }

        body.skin-dark {
            background: #0F2027;
            background: -webkit-linear-gradient(to right, #2C5364, #203A43, #0F2027);
            background: linear-gradient(to right, #2C5364, #203A43, #0F2027);
        }

        body.skin-warm {
            background: #3E5151;
            background: -webkit-linear-gradient(to right, #DECBA4, #3E5151);
            background: linear-gradient(to right, #DECBA4, #3E5151);
        }

        body.skin-green {
            background: #67B26F;
            background: -webkit-linear-gradient(to right, #4ca2cd, #67B26F);
            background: linear-gradient(to right, #4ca2cd, #67B26F);
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .glass-panel.collapsible {
            cursor: pointer;
            user-select: none;
        }

        .glass-panel.collapsible h2::after {
            content: ' ‚ñº';
            font-size: 16px;
            transition: transform 0.3s ease;
            display: inline-block;
        }

        .glass-panel.collapsible.collapsed h2::after {
            transform: rotate(-90deg);
        }

        .panel-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .panel-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        h2 {
            color: white;
            margin-bottom: 20px;
            font-weight: 500;
            font-size: 24px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            color: white;
            margin-bottom: 8px;
            font-weight: 400;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.9);
            font-family: 'Ubuntu', sans-serif;
            font-size: 14px;
            resize: vertical;
            min-height: 120px;
        }

        textarea:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.6);
            background: white;
        }

        select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.9);
            font-family: 'Ubuntu', sans-serif;
            font-size: 14px;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.6);
            background: white;
        }

        button {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Ubuntu', sans-serif;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        button:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5568d3 0%, #63408a 100%);
        }

        .btn-danger {
            background: rgba(220, 53, 69, 0.8);
            border: none;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: rgba(200, 35, 51, 0.9);
        }

        .btn-success {
            background: rgba(40, 167, 69, 0.8);
            border: none;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-success:hover {
            background: rgba(33, 136, 56, 0.9);
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            overflow: hidden;
        }

        thead {
            background: rgba(102, 126, 234, 0.9);
            color: white;
        }

        th {
            padding: 8px 12px;
            text-align: left;
            font-weight: 500;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
            vertical-align: top;
        }

        th > div {
            margin-bottom: 8px;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            white-space: nowrap;
        }

        tbody tr {
            transition: background 0.2s ease;
        }

        tbody tr:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .editable {
            cursor: text;
            min-width: 80px;
        }

        .editable:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .editable:focus {
            outline: 2px solid #667eea;
            background: white;
        }

        .filter-input {
            width: 100%;
            padding: 6px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 4px;
            font-family: 'Ubuntu', sans-serif;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.9);
        }

        .filter-input:focus {
            outline: none;
            border-color: white;
            background: white;
        }

        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner-overlay.active {
            display: flex;
        }

        .spinner-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            min-width: 300px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner-text {
            color: #333;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .spinner-detail {
            color: #666;
            font-size: 14px;
        }

        .batch-input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.9);
            font-family: 'Ubuntu', sans-serif;
            font-size: 14px;
            margin-top: 10px;
        }

        .batch-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.6);
            background: white;
        }

        .hidden {
            display: none;
        }

        .error-table {
            margin-top: 10px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .save-button-container {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
        }

        .save-button-container button {
            font-size: 18px;
            padding: 15px 40px;
        }

        /* Estilos para o seletor de tema discreto */
        .theme-selector-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }

        .theme-button {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            font-size: 24px;
            color: white;
        }

        .theme-button:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }

        .main-title {
            color: white;
            font-size: 36px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .theme-panel {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }

        .theme-panel {
            position: absolute;
            bottom: 60px;
            right: 0;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            display: none;
            flex-direction: column;
            gap: 10px;
        }

        .theme-panel.active {
            display: flex;
        }

        .skin-option {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .skin-option:hover {
            transform: scale(1.05);
        }

        .skin-option.active {
            border-color: white;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .skin-default {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .skin-dark {
            background: linear-gradient(to right, #2C5364, #203A43, #0F2027);
        }

        .skin-warm {
            background: linear-gradient(to right, #DECBA4, #3E5151);
        }

        .skin-green {
            background: linear-gradient(to right, #4ca2cd, #67B26F);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="main-title">Converter | Cadastro de Fornecedores</h1>
        <!-- Quadro Informe CNPJ -->
        <div class="glass-panel">
            <h2>üìã Informe CNPJ</h2>
            <div class="input-group">
                <label for="cnpjInput">Cole os CNPJs abaixo (um por linha):</label>
                <textarea id="cnpjInput" placeholder=""></textarea>
            </div>
            <button class="btn-primary" onclick="importarCNPJs()">Importar CNPJs</button>
        </div>

        <!-- Quadro Utilit√°rios (Recolh√≠vel) -->
        <div class="glass-panel collapsible collapsed" id="utilitiesPanel" onclick="togglePanel('utilitiesPanel')">
            <h2>üîß Utilit√°rios</h2>
            <div class="panel-content collapsed" onclick="event.stopPropagation()">
                <div class="input-group">
                    <label for="fieldSelect">Selecione o campo para preenchimento em lote:</label>
                    <select id="fieldSelect">
                        <option value="">-- Selecione um campo --</option>
                        <option value="codigo">C√≥digo</option>
                        <option value="razao_social">Raz√£o Social</option>
                        <option value="cnpj">CNPJ</option>
                        <option value="nome_fantasia">Nome Fantasia</option>
                        <option value="rua">Rua</option>
                        <option value="numero">N√∫mero</option>
                        <option value="bairro">Bairro</option>
                        <option value="telefone">Telefone</option>
                        <option value="cidade">Cidade</option>
                        <option value="estado">Estado(UF)</option>
                        <option value="inscricao_estadual">Inscri√ß√£o Estadual</option>
                        <option value="inscricao_municipal">Inscri√ß√£o Municipal</option>
                        <option value="conta_patrimonial">Conta Patrimonial</option>
                        <option value="conta_despesa">Conta Despesa</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="batchValue">Valor para preenchimento:</label>
                    <input type="text" class="batch-input" id="batchValue" placeholder="Digite o valor para preencher o campo selecionado">
                </div>
                <button onclick="preencherLote()">Preencher em Lote</button>
            </div>
        </div>

        <!-- Quadro Dados Importados -->
        <div class="glass-panel">
            <h2>üìä Dados Importados</h2>
            <div class="table-container">
                <table id="dadosTable">
                    <thead>
                        <tr>
                            <th>
                                <div>C√≥digo</div>
                                <input type="text" class="filter-input" placeholder="Filtrar..." onkeyup="filtrarTabela()">
                            </th>
                            <th>
                                <div>Raz√£o Social</div>
                                <input type="text" class="filter-input" placeholder="Filtrar..." onkeyup="filtrarTabela()">
                            </th>
                            <th>
                                <div>CNPJ</div>
                                <input type="text" class="filter-input" placeholder="Filtrar..." onkeyup="filtrarTabela()">
                            </th>
                            <th>
                                <div>Nome Fantasia</div>
                                <input type="text" class="filter-input" placeholder="Filtrar..." onkeyup="filtrarTabela()">
                            </th>
                            <th>
                                <div>Rua</div>
                                <input type="text" class="filter-input" placeholder="Filtrar..." onkeyup="filtrarTabela()">
                            </th>
                            <th>
                                <div>N√∫mero</div>
                                <input type="text" class="filter-input" placeholder="Filtrar..." onkeyup="filtrarTabela()">
                            </th>
                            <th>
                                <div>Bairro</div>
                                <input type="text" class="filter-input" placeholder="Filtrar..." onkeyup="filtrarTabela()">
                            </th>
                            <th>
                                <div>Telefone</div>
                                <input type="text" class="filter-input" placeholder="Filtrar..." onkeyup="filtrarTabela()">
                            </th>
                            <th>
                                <div>Cidade</div>
                                <input type="text" class="filter-input" placeholder="Filtrar..." onkeyup="filtrarTabela()">
                            </th>
                            <th>
                                <div>Estado(UF)</div>
                                <input type="text" class="filter-input" placeholder="Filtrar..." onkeyup="filtrarTabela()">
                            </th>
                            <th>
                                <div>Inscri√ß√£o Estadual</div>
                                <input type="text" class="filter-input" placeholder="Filtrar..." onkeyup="filtrarTabela()">
                            </th>
                            <th>
                                <div>Inscri√ß√£o Municipal</div>
                                <input type="text" class="filter-input" placeholder="Filtrar..." onkeyup="filtrarTabela()">
                            </th>
                            <th>
                                <div>Conta Patrimonial</div>
                                <input type="text" class="filter-input" placeholder="Filtrar..." onkeyup="filtrarTabela()">
                            </th>
                            <th>
                                <div>Conta Despesa</div>
                                <input type="text" class="filter-input" placeholder="Filtrar..." onkeyup="filtrarTabela()">
                            </th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="dadosTableBody">
                        <tr>
                            <td colspan="15" style="text-align: center; color: #666;">Nenhum dado importado ainda</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Quadro Empresas N√£o Importadas -->
        <div class="glass-panel hidden" id="errosPanel">
            <h2>‚ö†Ô∏è Empresas N√£o Importadas</h2>
            <div class="table-container">
                <table id="errosTable" class="error-table">
                    <thead>
                        <tr>
                            <th>CNPJ</th>
                            <th>Motivo</th>
                            <th>Tentativas</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="errosTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Bot√£o Salvar TXT no final -->
        <div class="glass-panel save-button-container">
            <div class="button-group" style="justify-content: center;">
                <button class="btn-primary" onclick="salvarTXT()">üíæ Salvar TXT</button>
                <button class="btn-primary" onclick="baixarConjuntoDados()">üì• Baixar conjunto de dados</button>
            </div>
        </div>
    </div>

    <!-- Seletor de Tema Discreto -->
    <div class="theme-selector-container">
        <div class="theme-panel" id="themePanel">
            <div class="skin-option skin-default active" onclick="changeSkin('default')" title="Tema Padr√£o"></div>
            <div class="skin-option skin-dark" onclick="changeSkin('dark')" title="Tema Escuro"></div>
            <div class="skin-option skin-warm" onclick="changeSkin('warm')" title="Tema Quente"></div>
            <div class="skin-option skin-green" onclick="changeSkin('green')" title="Tema Verde"></div>
        </div>
        <div class="theme-button" onclick="toggleThemePanel()">üé®</div>
    </div>

    <!-- Spinner Overlay -->
    <div class="spinner-overlay" id="spinnerOverlay">
        <div class="spinner-content">
            <div class="spinner"></div>
            <div class="spinner-text" id="spinnerText">Processando...</div>
            <div class="spinner-detail" id="spinnerDetail"></div>
        </div>
    </div>

    <script>
        let dadosImportados = [];
        let empresasComErro = [];
        let codigoSequencial = 1;
        let currentSkin = 'default';

        function toggleThemePanel() {
            document.getElementById('themePanel').classList.toggle('active');
        }

        function changeSkin(skin) {
            // Remove todas as classes de skin
            document.body.classList.remove('skin-dark', 'skin-warm', 'skin-green');
            
            // Remove active de todos os bot√µes
            document.querySelectorAll('.skin-option').forEach(opt => opt.classList.remove('active'));
            
            // Adiciona a nova skin
            if (skin !== 'default') {
                document.body.classList.add('skin-' + skin);
            }
            
            // Marca o bot√£o ativo
            document.querySelector('.skin-option.skin-' + skin).classList.add('active');
            
            currentSkin = skin;
            localStorage.setItem('selectedSkin', skin);
        }

        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            const content = panel.querySelector('.panel-content');
            
            panel.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        }

        function limparCNPJ(cnpj) {
            return cnpj.replace(/[^\d]/g, '');
        }

        function formatarCNPJ(cnpj) {
            cnpj = limparCNPJ(cnpj);
            if (cnpj.length === 14) {
                return cnpj.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
            }
            return cnpj;
        }

        function mostrarSpinner(texto, detalhe = '') {
            document.getElementById('spinnerOverlay').classList.add('active');
            document.getElementById('spinnerText').textContent = texto;
            document.getElementById('spinnerDetail').textContent = detalhe;
        }

        function esconderSpinner() {
            document.getElementById('spinnerOverlay').classList.remove('active');
        }

        async function consultarCNPJ(cnpj, tentativa = 1, maxTentativas = 5) {
            const cnpjLimpo = limparCNPJ(cnpj);
            
            if (cnpjLimpo.length !== 14) {
                throw new Error('CNPJ inv√°lido - deve conter 14 d√≠gitos');
            }

            try {
                const response = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpjLimpo}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('CNPJ n√£o encontrado na base de dados');
                    } else if (response.status === 429) {
                        throw new Error('Limite de requisi√ß√µes excedido - aguarde alguns segundos');
                    } else {
                        throw new Error(`Erro na API: ${response.status}`);
                    }
                }

                const data = await response.json();
                return {
                    codigo: codigoSequencial++,
                    razao_social: data.razao_social || '',
                    cnpj: formatarCNPJ(data.cnpj) || '',
                    nome_fantasia: data.nome_fantasia || '',
                    rua: data.logradouro || '',
                    numero: data.numero || '',
                    bairro: data.bairro || '',
                    telefone: data.ddd_telefone_1 || '',
                    cidade: data.municipio || '',
                    estado: data.uf || '',
                    inscricao_estadual: '',
                    inscricao_municipal: '',
                    conta_patrimonial: '',
                    conta_despesa: ''
                };
            } catch (error) {
                if (tentativa < maxTentativas) {
                    await new Promise(resolve => setTimeout(resolve, 1000 * tentativa));
                    return consultarCNPJ(cnpj, tentativa + 1, maxTentativas);
                }
                throw error;
            }
        }

        async function importarCNPJs() {
            const input = document.getElementById('cnpjInput').value;
            const cnpjs = input.split('\n').filter(c => c.trim() !== '');

            if (cnpjs.length === 0) {
                alert('Por favor, informe pelo menos um CNPJ');
                return;
            }

            mostrarSpinner('Importando empresas...', `0 de ${cnpjs.length} processadas`);

            for (let i = 0; i < cnpjs.length; i++) {
                const cnpj = cnpjs[i].trim();
                mostrarSpinner('Importando empresas...', `${i + 1} de ${cnpjs.length} processadas`);

                try {
                    const dados = await consultarCNPJ(cnpj);
                    dadosImportados.push(dados);
                    atualizarTabela();
                } catch (error) {
                    adicionarEmpresaComErro(cnpj, error.message, 5);
                }

                // Pequeno delay entre requisi√ß√µes para evitar rate limit
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            esconderSpinner();
            document.getElementById('cnpjInput').value = '';
            
            if (empresasComErro.length > 0) {
                document.getElementById('errosPanel').classList.remove('hidden');
                atualizarTabelaErros();
            }
        }

        function adicionarEmpresaComErro(cnpj, motivo, tentativas) {
            empresasComErro.push({
                cnpj: cnpj,
                motivo: motivo,
                tentativas: tentativas
            });
        }

        async function tentarNovamente(cnpj, index) {
            mostrarSpinner('Tentando importar novamente...', cnpj);

            try {
                const dados = await consultarCNPJ(cnpj);
                dadosImportados.push(dados);
                atualizarTabela();
                empresasComErro.splice(index, 1);
                atualizarTabelaErros();

                if (empresasComErro.length === 0) {
                    document.getElementById('errosPanel').classList.add('hidden');
                }
            } catch (error) {
                alert(`Erro ao importar ${cnpj}: ${error.message}`);
            }

            esconderSpinner();
        }

        function atualizarTabela() {
            const tbody = document.getElementById('dadosTableBody');
            
            if (dadosImportados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="15" style="text-align: center; color: #666;">Nenhum dado importado ainda</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            dadosImportados.forEach((dados, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td contenteditable="true" class="editable" data-index="${index}" data-field="codigo">${dados.codigo}</td>
                    <td contenteditable="true" class="editable" data-index="${index}" data-field="razao_social">${dados.razao_social}</td>
                    <td contenteditable="true" class="editable" data-index="${index}" data-field="cnpj">${dados.cnpj}</td>
                    <td contenteditable="true" class="editable" data-index="${index}" data-field="nome_fantasia">${dados.nome_fantasia}</td>
                    <td contenteditable="true" class="editable" data-index="${index}" data-field="rua">${dados.rua}</td>
                    <td contenteditable="true" class="editable" data-index="${index}" data-field="numero">${dados.numero}</td>
                    <td contenteditable="true" class="editable" data-index="${index}" data-field="bairro">${dados.bairro}</td>
                    <td contenteditable="true" class="editable" data-index="${index}" data-field="telefone">${dados.telefone}</td>
                    <td contenteditable="true" class="editable" data-index="${index}" data-field="cidade">${dados.cidade}</td>
                    <td contenteditable="true" class="editable" data-index="${index}" data-field="estado">${dados.estado}</td>
                    <td contenteditable="true" class="editable" data-index="${index}" data-field="inscricao_estadual">${dados.inscricao_estadual}</td>
                    <td contenteditable="true" class="editable" data-index="${index}" data-field="inscricao_municipal">${dados.inscricao_municipal}</td>
                    <td contenteditable="true" class="editable" data-index="${index}" data-field="conta_patrimonial">${dados.conta_patrimonial}</td>
                    <td contenteditable="true" class="editable" data-index="${index}" data-field="conta_despesa">${dados.conta_despesa}</td>
                    <td><button class="btn-danger" onclick="excluirLinha(${index})">Excluir</button></td>
                `;
                tbody.appendChild(tr);
            });

            // Adicionar event listeners para atualizar os dados ao editar
            document.querySelectorAll('.editable').forEach(cell => {
                cell.addEventListener('blur', function() {
                    const index = parseInt(this.dataset.index);
                    const field = this.dataset.field;
                    dadosImportados[index][field] = this.textContent.trim();
                });
            });
        }

        function atualizarTabelaErros() {
            const tbody = document.getElementById('errosTableBody');
            tbody.innerHTML = '';

            empresasComErro.forEach((erro, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatarCNPJ(erro.cnpj)}</td>
                    <td>${erro.motivo}</td>
                    <td>${erro.tentativas} tentativas realizadas</td>
                    <td><button class="btn-success" onclick="tentarNovamente('${erro.cnpj}', ${index})">Tentar Novamente</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function excluirLinha(index) {
            if (confirm('Deseja realmente excluir esta linha?')) {
                dadosImportados.splice(index, 1);
                atualizarTabela();
            }
        }

        function filtrarTabela() {
            const table = document.getElementById('dadosTable');
            const tbody = table.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');
            const filters = table.querySelectorAll('.filter-input');

            rows.forEach(row => {
                let mostrar = true;
                filters.forEach((filter, colIndex) => {
                    const filterValue = filter.value.toLowerCase();
                    if (filterValue) {
                        const cell = row.cells[colIndex];
                        if (cell) {
                            const cellText = cell.textContent.toLowerCase();
                            if (!cellText.includes(filterValue)) {
                                mostrar = false;
                            }
                        }
                    }
                });
                row.style.display = mostrar ? '' : 'none';
            });
        }

        function preencherLote() {
            const campo = document.getElementById('fieldSelect').value;
            const valor = document.getElementById('batchValue').value;

            if (!campo) {
                alert('Por favor, selecione um campo');
                return;
            }

            if (!valor) {
                alert('Por favor, informe um valor para preenchimento');
                return;
            }

            dadosImportados.forEach(dados => {
                dados[campo] = valor;
            });

            atualizarTabela();
            alert('Preenchimento em lote realizado com sucesso!');
        }

        function baixarConjuntoDados() {
            // Criar um link para download do arquivo XML
            const link = document.createElement('a');
            link.href = 'Conjunto_Importa_Fornecedores.xml';
            link.download = 'Conjunto_Importa_Fornecedores.xml';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function salvarTXT() {
            if (dadosImportados.length === 0) {
                alert('N√£o h√° dados para salvar');
                return;
            }

            mostrarSpinner('Gerando arquivo TXT...', 'Preparando dados para exporta√ß√£o');

            setTimeout(() => {
                let conteudo = '';
                
                dadosImportados.forEach(dados => {
                    const linha = [
                        dados.codigo,
                        dados.razao_social,
                        dados.cnpj,
                        dados.nome_fantasia,
                        dados.rua,
                        dados.numero,
                        dados.bairro,
                        dados.telefone,
                        dados.cidade,
                        dados.estado,
                        dados.inscricao_estadual,
                        dados.inscricao_municipal,
                        dados.conta_patrimonial,
                        dados.conta_despesa
                    ].join(';');
                    conteudo += linha + '\n';
                });

                // Converter para ANSI (Windows-1252)
                const blob = new Blob([conteudo], { type: 'text/plain;charset=windows-1252' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cnpj_dados_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                esconderSpinner();
                alert('Arquivo TXT salvo com sucesso!');
            }, 500);
        }

        // Carregar skin salva ao iniciar
        window.addEventListener('load', function() {
            const savedSkin = localStorage.getItem('selectedSkin');
            if (savedSkin) {
                changeSkin(savedSkin);
            } else {
                // Garante que o tema padr√£o esteja ativo no carregamento inicial
                document.querySelector('.skin-option.skin-default').classList.add('active');
            }
        });
    </script>
</body>
</html>
